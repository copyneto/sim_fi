sap.ui.define([                                                                                                                                                                                                                                                
    "sap/m/MessageToast",                                                                                                                                                                                                                                      
    "sap/m/PDFViewer",                                                                                                                                                                                                                                         
    "sap/ui/model/Filter"                                                                                                                                                                                                                                      
], function (MessageToast, PDFViewer, Filter) {                                                                                                                                                                                                                
    'use strict';                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return {                                                                                                                                                                                                                                                   
        onBeforeRendering: function () {                                                                                                                                                                                                                       
            this.getView().byId(this.byId("btnCustodiaChequeButton").getId()).setIcon("sap-icon://pdf-attachment");                                                                                                                                            
            this.getView().byId(this.byId("btnGerarArquivoButtonButton").getId()).setIcon("sap-icon://attachment-text-file");                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        getPDFData: function (oEvent, tipo) {                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            let aFilter = [];                                                                                                                                                                                                                                  
            let oExtApi = this.templateBaseExtension.getExtensionAPI();                                                                                                                                                                                        
            // get the Model reference                                                                                                                                                                                                                         
            var oModel = this.getView().getModel();                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            let oCtx = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            aFilter.push(new Filter("Tipo", "EQ", tipo));                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            for (let oCtx of oExtApi.getSelectedContexts()) {                                                                                                                                                                                                  
                aFilter.push(new Filter("Bukrs", "EQ", oCtx.getObject().Bukrs));                                                                                                                                                                               
                aFilter.push(new Filter("Kunnr", "EQ", oCtx.getObject().Kunnr));                                                                                                                                                                               
                aFilter.push(new Filter("Ncheque", "EQ", oCtx.getObject().Ncheque));                                                                                                                                                                           
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            aFilter = this.removerDuplicatas(aFilter);                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                // Perform Read operation and pass billingdoc as parameter to URL                                                                                                                                                                              
                oModel.read("/PDF", {                                                                                                                                                                                                                          
                    filters: aFilter,                                                                                                                                                                                                                          
                    success: function (oData, oResponse) {                                                                                                                                                                                                     
                        resolve(oData);                                                                                                                                                                                                                        
                    },                                                                                                                                                                                                                                         
                    error: function (oError) {                                                                                                                                                                                                                 
                        reject(oError);                                                                                                                                                                                                                        
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
            })                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onCustodiaCheque: async function (oEvent) {                                                                                                                                                                                                            
            var that = this;                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            var opdfViewer = new PDFViewer();                                                                                                                                                                                                                  
            that.getView().addDependent(opdfViewer);                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            var vPDF = await that.getPDFData(oEvent, "PDF");                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            if (vPDF === '') {                                                                                                                                                                                                                                 
                MessageBox.error("Erro ao gerar PDF")                                                                                                                                                                                                          
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            let base64EncodedPDF = vPDF.results[0].stream_data;                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            let decodedPdfContent = atob(base64EncodedPDF);                                                                                                                                                                                                    
            let byteArray = new Uint8Array(decodedPdfContent.length);                                                                                                                                                                                          
            for (var i = 0; i < decodedPdfContent.length; i++) {                                                                                                                                                                                               
                byteArray[i] = decodedPdfContent.charCodeAt(i);                                                                                                                                                                                                
            }                                                                                                                                                                                                                                                  
            var blob = new Blob([byteArray.buffer], {                                                                                                                                                                                                          
                type: 'application/pdf'                                                                                                                                                                                                                        
            });                                                                                                                                                                                                                                                
            var pdfurl = URL.createObjectURL(blob);                                                                                                                                                                                                            
            jQuery.sap.addUrlWhitelist("blob"); // register blob url as whitelist                                                                                                                                                                              
            opdfViewer.setSource(pdfurl);                                                                                                                                                                                                                      
            opdfViewer.setVisible(true);                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
            opdfViewer.setTitle("Formulário de Cheques");                                                                                                                                                                                                      
            opdfViewer.open();                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
        onGerarArquivo: async function (oEvent) {                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            var that = this;                                                                                                                                                                                                                                   
            var txt = "";                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            var res = await that.getPDFData(oEvent, "TXT");                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            if (res === '') {                                                                                                                                                                                                                                  
                MessageBox.error("Erro ao gerar o TXT");                                                                                                                                                                                                       
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
            for (let r of res.results) {                                                                                                                                                                                                                       
                txt += r.txt;                                                                                                                                                                                                                                  
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            that.downloadTxt(txt);                                                                                                                                                                                                                             
            that.getView().getModel().refresh(true);                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            // let oExtApi = this.templateBaseExtension.getExtensionAPI();                                                                                                                                                                                     
            // // get the Model reference                                                                                                                                                                                                                      
            // var oModel = this.getView().getModel();                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
            // let oCtx = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // for (let oCtx of oExtApi.getSelectedContexts()) {                                                                                                                                                                                               
            //     txt += oCtx.getObject().Bukrs + ';' +                                                                                                                                                                                                       
            //         oCtx.getObject().Kunnr + ';' +                                                                                                                                                                                                          
            //         oCtx.getObject().Ncheque + ';' +                                                                                                                                                                                                        
            //         oCtx.getObject().Budat + ';' +                                                                                                                                                                                                          
            //         oCtx.getObject().Ncontrato + ';' +                                                                                                                                                                                                      
            //         oCtx.getObject().Ncontratojuridico + ';' +                                                                                                                                                                                              
            //         oCtx.getObject().Bupla + ';' +                                                                                                                                                                                                          
            //         oCtx.getObject().Zterm + ';' +                                                                                                                                                                                                          
            //         oCtx.getObject().Nchamado + ';' +                                                                                                                                                                                                       
            //         oCtx.getObject().Valor + ';' +                                                                                                                                                                                                          
            //         oCtx.getObject().Moeda + '\n';                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
            // }                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            // var currentDate = new Date();                                                                                                                                                                                                                   
            // var formattedDate = currentDate.toISOString().slice(0, 19).replace("T", " "); // Formato: YYYY-MM-DD HH:MM:SS                                                                                                                                   
            // // Crie o data URL e abra a janela                                                                                                                                                                                                              
            // var dataUrl = "data:application/txt;charset=utf-8," + encodeURIComponent(txt);                                                                                                                                                                  
            // var link = document.createElement("a");                                                                                                                                                                                                         
            // link.href = dataUrl;                                                                                                                                                                                                                            
            // link.download = "Arquivo-" + formattedDate + ".txt";                                                                                                                                                                                            
            // document.body.appendChild(link);                                                                                                                                                                                                                
            // link.click();                                                                                                                                                                                                                                   
            // document.body.removeChild(link);                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            // // window.open(dataUrl, "_self");                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
        downloadTxt: function (txt) {                                                                                                                                                                                                                          
            var currentDate = new Date();                                                                                                                                                                                                                      
            var formattedDate = currentDate.toISOString().slice(0, 19).replace("T", " "); // Formato: YYYY-MM-DD HH:MM:SS                                                                                                                                      
            // Crie o data URL e abra a janela                                                                                                                                                                                                                 
            var dataUrl = "data:application/txt;charset=utf-8," + encodeURIComponent(txt);                                                                                                                                                                     
            var link = document.createElement("a");                                                                                                                                                                                                            
            link.href = dataUrl;                                                                                                                                                                                                                               
            link.download = "Arquivo-" + formattedDate + ".txt";                                                                                                                                                                                               
            document.body.appendChild(link);                                                                                                                                                                                                                   
            link.click();                                                                                                                                                                                                                                      
            document.body.removeChild(link);                                                                                                                                                                                                                   
        },                                                                                                                                                                                                                                                     
        removerDuplicatas: function (arr) {                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            const seen = new Set();                                                                                                                                                                                                                            
            return arr.filter((obj) => {                                                                                                                                                                                                                       
                const serialized = JSON.stringify(obj);                                                                                                                                                                                                        
                return !seen.has(serialized) && seen.add(serialized);                                                                                                                                                                                          
            })                                                                                                                                                                                                                                                 
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
    };                                                                                                                                                                                                                                                         
});                                                                                                                                                                                                                                                            